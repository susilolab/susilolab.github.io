<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Menulis NIF Rust dengan Rustler - susilolab</title><meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="Kali ini saya ingin berbagi pengetahuan mengenai cara menulis NIF dengan Rustler tapi sebelum itu saya ingin mengenalkan apa itu NIF. NIF kependekan dari Native Implemented Function yaitu memanggil fungsi dari pustaka luar. Kenapa harus menggunakan NIF? alasan pertama karena beberapa fungsi pada pustaka tertentu tidak ada di elixir, alasan kedua yaitu agar performa aplikasi meningkat. NIF biasanya dibuat dengan bahasa C namun kali ini saya ingin menggunakan bahasa Rust karena alasan keamanan dan kecepatan. Pustaka rustler mengklaim library yang ditulis tidak akan menyebabkan virtual mesin BEAM crash sehingga kita tidak perlu khawatir dan fokus ke penulisan pustaka."><meta property="og:image" content><meta property="og:title" content="Menulis NIF Rust dengan Rustler"><meta property="og:description" content="Kali ini saya ingin berbagi pengetahuan mengenai cara menulis NIF dengan Rustler tapi sebelum itu saya ingin mengenalkan apa itu NIF. NIF kependekan dari Native Implemented Function yaitu memanggil fungsi dari pustaka luar. Kenapa harus menggunakan NIF? alasan pertama karena beberapa fungsi pada pustaka tertentu tidak ada di elixir, alasan kedua yaitu agar performa aplikasi meningkat. NIF biasanya dibuat dengan bahasa C namun kali ini saya ingin menggunakan bahasa Rust karena alasan keamanan dan kecepatan. Pustaka rustler mengklaim library yang ditulis tidak akan menyebabkan virtual mesin BEAM crash sehingga kita tidak perlu khawatir dan fokus ke penulisan pustaka."><meta property="og:type" content="article"><meta property="og:url" content="https://susilolab.github.io/posts/2020-03-29-menulis-nif-rust-dengan-rustler/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-03-29T08:00:00+00:00"><meta property="article:modified_time" content="2020-03-29T08:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Menulis NIF Rust dengan Rustler"><meta name=twitter:description content="Kali ini saya ingin berbagi pengetahuan mengenai cara menulis NIF dengan Rustler tapi sebelum itu saya ingin mengenalkan apa itu NIF. NIF kependekan dari Native Implemented Function yaitu memanggil fungsi dari pustaka luar. Kenapa harus menggunakan NIF? alasan pertama karena beberapa fungsi pada pustaka tertentu tidak ada di elixir, alasan kedua yaitu agar performa aplikasi meningkat. NIF biasanya dibuat dengan bahasa C namun kali ini saya ingin menggunakan bahasa Rust karena alasan keamanan dan kecepatan. Pustaka rustler mengklaim library yang ditulis tidak akan menyebabkan virtual mesin BEAM crash sehingga kita tidak perlu khawatir dan fokus ke penulisan pustaka."><script src=https://susilolab.github.io/js/feather.min.js></script><link href=https://susilolab.github.io/css/fonts.eeaf17fd5344c59efcf7fc5c93b898a92cd323eda28c7f1546bbb5f99b42f174.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://susilolab.github.io/css/main.c7dbc780852ad2fc2aae08ae19f1dea5e34c4ef11a83ab0f9b0a025b148de8a1.css></head><body><div class=container><div class=header-wrapper><header class=header-app><div class=main><a href=https://susilolab.github.io/>susilolab</a></div><nav class=navmain><a href=/>Home</a>
<a href=/posts>All posts</a>
<a href=/portfolio>My Portfolio</a>
<a href=/about>About</a>
<a href=/tags>Tags</a>
<a href=/categories>Categories</a></nav></header></div><div class=border-top></div><div class=content><main><article><div class=title><h1 class=title>Menulis NIF Rust dengan Rustler</h1><div class=meta><i data-feather=calendar></i> 29 Mar 2020</div><div class=page-categories><a href=/categories/elixir/>elixir</a></div></div><section class=body><p>Kali ini saya ingin berbagi pengetahuan mengenai cara menulis NIF dengan <code>Rustler</code> tapi sebelum itu saya ingin mengenalkan apa itu <code>NIF</code>. NIF kependekan dari Native Implemented Function yaitu memanggil fungsi dari pustaka luar. Kenapa harus menggunakan NIF? alasan pertama karena beberapa fungsi pada pustaka tertentu tidak ada di elixir, alasan kedua yaitu agar performa aplikasi meningkat. NIF biasanya dibuat dengan bahasa C namun kali ini saya ingin menggunakan bahasa Rust karena alasan keamanan dan kecepatan. Pustaka rustler mengklaim library yang ditulis tidak akan menyebabkan virtual mesin BEAM crash sehingga kita tidak perlu khawatir dan fokus ke penulisan pustaka.</p><p>Ok kita mulai saja, pertama buat project elixir dengan command mix. Pertama-tama buat project elixir dengan nama hello_nif<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mix new hello_nif</span></span></code></pre></div><img src=/img/2019-10-14-new-mix-project.png alt=new-mix-project></p><p>Lalu tambahkan pustaka <em>rustler</em> ke file mix.exs<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span><span style=color:#66d9ef>defp</span> deps <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  [
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>:rustler</span>, <span style=color:#e6db74>&#34;~&gt; 0.21.0&#34;</span>}
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span></span></span></code></pre></div></p><p>Kemudian jalankan mix deps.get<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mix deps.get</span></span></code></pre></div><img src=/img/2019-10-14-mix-deps-get.png alt=mix-deps-get></p><p>Setelah itu compile project elixir dengan mix compile agar mix task dari rustler muncul<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mix compile</span></span></code></pre></div><img src=/img/2019-10-14-mix-compile.png alt=mix-compile></p><p>Kemudian kita akan memulai membuat pustaka nif. Untuk nama modul kita samakan dengan nama project elixir yaitu <strong>HelloNif</strong> dan nama libnya <strong>hello_nif</strong>. rustler akan membuatkan rust project yang akan mengkompile otomatis saat kita menjalankan <code>mix compile</code> atau <code>iex -S mix</code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mix rustler.new
</span></span><span style=display:flex><span>This is the name of the Elixir module the NIF module will be registered to.
</span></span><span style=display:flex><span>Module name &gt; HelloNif
</span></span><span style=display:flex><span>This is the name used <span style=color:#66d9ef>for</span> the generated Rust crate. The default is most likely fine.
</span></span><span style=display:flex><span>Library name <span style=color:#f92672>(</span>hellonif<span style=color:#f92672>)</span> &gt; hello_nif
</span></span><span style=display:flex><span>* creating native/hello_nif/.cargo/config
</span></span><span style=display:flex><span>* creating native/hello_nif/README.md
</span></span><span style=display:flex><span>* creating native/hello_nif/Cargo.toml
</span></span><span style=display:flex><span>* creating native/hello_nif/src/lib.rs
</span></span><span style=display:flex><span>Ready to go! See /home/susilo/var/Elixir/hello_nif/native/hello_nif/README.md <span style=color:#66d9ef>for</span> further instructions.</span></span></code></pre></div></p><p>Maka akan ada folder native/hello_nif didalam folder project elixir, folder ini akan berisi pustaka nif yang kita buat dengan perintah <code>mix rustler.new</code>. source code dari lib.rs kurang lebih akan seperti dibawah ini<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>#[macro_use]</span> <span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>crate</span> rustler;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> rustler::{Encoder, Env, Error, Term};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>mod</span> atoms {
</span></span><span style=display:flex><span>    rustler_atoms! {
</span></span><span style=display:flex><span>        atom ok;
</span></span><span style=display:flex><span>        <span style=color:#75715e>//atom error;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>//atom __true__ = &#34;true&#34;;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>//atom __false__ = &#34;false&#34;;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rustler::rustler_export_nifs! {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;Elixir.HelloNif&#34;</span>,
</span></span><span style=display:flex><span>    [
</span></span><span style=display:flex><span>        (<span style=color:#e6db74>&#34;add&#34;</span>, <span style=color:#ae81ff>2</span>, add)
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    None
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>add</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;a</span><span style=color:#f92672>&gt;</span>(env: <span style=color:#a6e22e>Env</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;a</span><span style=color:#f92672>&gt;</span>, args: <span style=color:#66d9ef>&amp;</span>[Term<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;a</span><span style=color:#f92672>&gt;</span>]) -&gt; Result<span style=color:#f92672>&lt;</span>Term<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;a</span><span style=color:#f92672>&gt;</span>, Error<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> num1: <span style=color:#66d9ef>i64</span> <span style=color:#f92672>=</span> args[<span style=color:#ae81ff>0</span>].decode()<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> num2: <span style=color:#66d9ef>i64</span> <span style=color:#f92672>=</span> args[<span style=color:#ae81ff>1</span>].decode()<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Ok((atoms::ok(), num1 <span style=color:#f92672>+</span> num2).encode(env))
</span></span><span style=display:flex><span>}</span></span></code></pre></div></p><p>Kode diatas hanya ada satu fungsi yaitu <code>add</code> dengan 2 parameter berupa angka. <code>rustler_atoms!</code> berguna untuk membuat atom elixir dan <code>rustler::rustler_export_nifs!</code> berguna untuk mengexport modul dan fungsinya sehingga dapat diakses dari elixir.</p><p>Langkah selanjutnya adalah menambah informasi agar mix dapat mengkompile pustaka yang kita buat. tambahkan custom compiler dan daftar pustaka nif ke dalam fungsi project, lalu buat fungsi rustler_crates yang memuat lokasi pustaka nif.<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span><span style=color:#66d9ef>defmodule</span> <span style=color:#a6e22e>HelloNif.MixProject</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>use</span> <span style=color:#a6e22e>Mix.Project</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> project <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    [
</span></span><span style=display:flex><span>      ...
</span></span><span style=display:flex><span>      <span style=color:#e6db74>compilers</span>: [<span style=color:#e6db74>:rustler</span>] <span style=color:#f92672>++</span> <span style=color:#a6e22e>Mix</span><span style=color:#f92672>.</span>compilers(),
</span></span><span style=display:flex><span>      <span style=color:#e6db74>rustler_crates</span>: rustler_crates(),
</span></span><span style=display:flex><span>      ...
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>defp</span> rustler_crates <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    [
</span></span><span style=display:flex><span>      <span style=color:#e6db74>hello_nif</span>: [<span style=color:#e6db74>path</span>: <span style=color:#e6db74>&#34;native/hello_nif&#34;</span>, <span style=color:#e6db74>mode</span>: <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>Mix</span><span style=color:#f92672>.</span>env() <span style=color:#f92672>==</span> <span style=color:#e6db74>:prod</span>, <span style=color:#e6db74>do</span>: <span style=color:#e6db74>:release</span>, <span style=color:#e6db74>else</span>: <span style=color:#e6db74>:debug</span>)],
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span></span></span></code></pre></div></p><p>Langkah selanjutnya adalah menambahkan <code>use Rustler</code> dan definisi nama fungsi pada modul <code>HelloNif</code> sehingga fungsi yang dibuat dengan rust dapat diakses di dalam elixir.<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span><span style=color:#66d9ef>defmodule</span> <span style=color:#a6e22e>HelloNif</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>use</span> <span style=color:#a6e22e>Rustler</span>, <span style=color:#e6db74>otp_app</span>: <span style=color:#e6db74>:hello_nif</span>, <span style=color:#e6db74>crate</span>: <span style=color:#e6db74>:hello_nif</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> add(_a, _b), <span style=color:#e6db74>do</span>: <span style=color:#e6db74>:erlang</span><span style=color:#f92672>.</span>nif_error(<span style=color:#e6db74>:nif_not_loaded</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> hello <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>:world</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span></span></span></code></pre></div></p><p>Kemudian kita bisa mengujinya menggunakan interaktif elixir atau <code>iex</code> dengan cara mengetikan perintah berikut ini pada terminal<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ iex -S mix</span></span></code></pre></div></p><p>Pada saat kita menjalankan perintah <code>iex -S mix</code> library dari rustler akan otomatis mengkompile pustaka yang kita tulis dengan bahasa pemrograman rust.
<img src=/img/2020-03-25-iex-smix.png alt=mix-compile></p><p>Setelah rustler selesai mengkompile pustaka maka konsol <code>iex</code> juga akan muncul. nah setelah muncul kita bisa mencoba mengakses fungsi yang telah kita buat dengan rust.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>iex<span style=color:#f92672>(</span>1<span style=color:#f92672>)</span>&gt; HelloNif.add<span style=color:#f92672>(</span>1, 2<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>:ok, 3<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>iex<span style=color:#f92672>(</span>2<span style=color:#f92672>)</span>&gt;</span></span></code></pre></div><p>Jika tidak ada error maka akan keluar pesan berupa tuple atom <code>:ok</code> dan angka 3.</p><p>Sekian semoga bermanfaat.</p></section><div class=post-tags></div></article></main><footer style=display:flex;justify-content:space-between><div style=width:50%><ul class=social-wrapper><li><a class=soc href=https://github.com/susilolab rel=me title=susilolab><i data-feather=github></i><span class=soc-name>GitHub</span></a></li><li><a class=soc href=https://twitter.com/susil0/ rel=me title=susil0><i data-feather=twitter></i><span class=soc-name>Twitter</span></a></li><li><a class=soc href=https://gitlab.com/susilolab/ rel=me title=susilolab><i data-feather=gitlab></i><span class=soc-name>GitLab</span></a></li></ul></div><div class=footer-info><p>"Sebaik-baik manusia adalah yang paling bermanfaat bagi manusia" (HR. Ahmad, ath-Thabrani, ad-Daruqutni)</p><p>2024 © susilolab | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></p></div></footer><script>feather.replace()</script></div></div></body></html>