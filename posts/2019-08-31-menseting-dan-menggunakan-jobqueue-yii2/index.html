<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Menseting dan menggunakan Job Queue pada Yii2 - susilolab</title><meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="Pada Yii2 sudah didukung dengan ektensi job queue yang memungkinkan kita menjalankan tugas secara asynkron via antrian. Job Queue pada yii2 mendukung DB, Redis, RabbitMQ, AMQP, BeansTalk, ActiveMQ dan Gearman."><meta property="og:image" content><meta property="og:title" content="Menseting dan menggunakan Job Queue pada Yii2"><meta property="og:description" content="Pada Yii2 sudah didukung dengan ektensi job queue yang memungkinkan kita menjalankan tugas secara asynkron via antrian. Job Queue pada yii2 mendukung DB, Redis, RabbitMQ, AMQP, BeansTalk, ActiveMQ dan Gearman."><meta property="og:type" content="article"><meta property="og:url" content="https://susilolab.github.io/posts/2019-08-31-menseting-dan-menggunakan-jobqueue-yii2/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-08-31T18:30:00+00:00"><meta property="article:modified_time" content="2019-08-31T18:30:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Menseting dan menggunakan Job Queue pada Yii2"><meta name=twitter:description content="Pada Yii2 sudah didukung dengan ektensi job queue yang memungkinkan kita menjalankan tugas secara asynkron via antrian. Job Queue pada yii2 mendukung DB, Redis, RabbitMQ, AMQP, BeansTalk, ActiveMQ dan Gearman."><script src=https://susilolab.github.io/js/feather.min.js></script><link href=https://susilolab.github.io/css/fonts.eeaf17fd5344c59efcf7fc5c93b898a92cd323eda28c7f1546bbb5f99b42f174.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://susilolab.github.io/css/main.c7dbc780852ad2fc2aae08ae19f1dea5e34c4ef11a83ab0f9b0a025b148de8a1.css></head><body><div class=container><div class=header-wrapper><header class=header-app><div class=main><a href=https://susilolab.github.io/>susilolab</a></div><nav class=navmain><a href=/>Home</a>
<a href=/posts>All posts</a>
<a href=/portfolio>My Portfolio</a>
<a href=/about>About</a>
<a href=/tags>Tags</a>
<a href=/categories>Categories</a></nav></header></div><div class=border-top></div><div class=content><main><article><div class=title><h1 class=title>Menseting dan menggunakan Job Queue pada Yii2</h1><div class=meta><i data-feather=calendar></i> 31 Aug 2019</div><div class=page-categories><a href=/categories/php/>php</a></div></div><section class=body><p>Pada Yii2 sudah didukung dengan ektensi job queue yang memungkinkan kita menjalankan tugas secara asynkron via antrian. Job Queue pada yii2 mendukung <strong>DB</strong>, <strong>Redis</strong>, <strong>RabbitMQ</strong>, <strong>AMQP</strong>, <strong>BeansTalk</strong>, <strong>ActiveMQ</strong> dan <strong>Gearman</strong>.</p><p>Saya hanya akan sedikit berbagi job queue dengan redis sebagai backendnya. Saya list apa-apa yang akan kita lakukan.</p><ul><li>Install ektensi yii2-queue</li><li>Seting queue di web.php dan console.php</li><li>Membuat klas tugas</li><li>Menjalankan queue cli</li></ul><p>Pertama kita install dulu ektensi yii2-queue</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ php composer.phar require --prefer-dist yiisoft/yii2-queue</span></span></code></pre></div><p>Kemudian kita perlu memasukan setingan yii2-queue ke file config console dan web</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#75715e>// masukan pada file web.php dan console.php
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;components&#39;</span> <span style=color:#f92672>=&gt;</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;queue&#39;</span> <span style=color:#f92672>=&gt;</span> [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;class&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>\yii\queue\redis\Queue</span><span style=color:#f92672>::</span><span style=color:#a6e22e>class</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;as log&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>\yii\queue\LogBehavior</span><span style=color:#f92672>::</span><span style=color:#a6e22e>class</span>,
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>],
</span></span><span style=display:flex><span><span style=color:#f92672>...</span></span></span></code></pre></div><p>Untuk file <code>console.php</code> kita juga perlu memasukan queue ke konfig bootstrap seperti ini</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#75715e>// console.log
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;bootstrap&#39;</span> <span style=color:#f92672>=&gt;</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;queue&#39;</span>,
</span></span><span style=display:flex><span>],
</span></span><span style=display:flex><span><span style=color:#f92672>...</span></span></span></code></pre></div><p>Langkah berikutnya adalah membuat klas job/tugas yang akan kita kirim ke queue yang harus dipisah menjadi klas. Klas ini wajib mendefinisikan fungsi <code>execute</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>namespace</span> <span style=color:#a6e22e>app\jobs</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>yii\base\BaseObject</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DownloadJob</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>BaseObject</span> <span style=color:#66d9ef>implements</span> <span style=color:#a6e22e>\yii\queue\JobInterface</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> $url;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> $file;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>execute</span>($queue)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>file_put_contents</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>file</span>, <span style=color:#a6e22e>file_get_contents</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>url</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>Setelah kita membuat klas tugas maka kita dapat mengirim tugas dari mana saja seperti dari model, controller, module, view dll. Cara mengirim tugas ke queue seperti berikut ini:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#a6e22e>Yii</span><span style=color:#f92672>::</span>$app<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>queue</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>push</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>\app\jobs\Download</span>([
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;url&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;https://example.com/image.png&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;file&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;/tmp/image.png&#39;</span>
</span></span><span style=display:flex><span>]));</span></span></code></pre></div><p>Langkah terakhir yang harus dilakukan adalah menjalankan console queue melalui terminal atau bisa dengan membuat service dilinux. cara menjalankan consolenya seperti dibawah. buka terminal lalu masuk ke folder dimana yii/yii.bat berada.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># jalankan semua queue dan exit setelah tidak ada queue</span>
</span></span><span style=display:flex><span>$ yii queue/run -v
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># jalankan semua queue dan loop</span>
</span></span><span style=display:flex><span>$ yii queue/listen -v</span></span></code></pre></div><p>Dengan adanya job queue akan mengurangi beban webserver dalam memproses request dan job queue tidak terkena timeout dari php. Contoh kasusnya bisa untuk mengirim email ke user secara masal atau mengenerate file xls yang jumlah barisnya ribuan atau pekerjaan yang sifatnya logging.</p></section><div class=post-tags></div></article></main><footer style=display:flex;justify-content:space-between><div style=width:50%><ul class=social-wrapper><li><a class=soc href=https://github.com/susilolab rel=me title=susilolab><i data-feather=github></i><span class=soc-name>GitHub</span></a></li><li><a class=soc href=https://twitter.com/susil0/ rel=me title=susil0><i data-feather=twitter></i><span class=soc-name>Twitter</span></a></li><li><a class=soc href=https://gitlab.com/susilolab/ rel=me title=susilolab><i data-feather=gitlab></i><span class=soc-name>GitLab</span></a></li></ul></div><div class=footer-info><p>"Sebaik-baik manusia adalah yang paling bermanfaat bagi manusia" (HR. Ahmad, ath-Thabrani, ad-Daruqutni)</p><p>2024 © susilolab | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></p></div></footer><script>feather.replace()</script></div></div></body></html>